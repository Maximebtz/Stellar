{% extends 'base.html.twig' %}
{% block title %}{{ advert.title }}{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('build/style.css') }}" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
  rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script>
  // Initialize and add the map
  let map;
  const CURRENT_ADVERT_ID = "{{ advert.id }}";

  async function initMap() {
    // Initialisation du géocodeur
    let geocoder = new google.maps.Geocoder();

    // Déclaration des informations de l'annonce en cours
    let address = "{{ advert.address }}, {{ advert.city }}, {{ advert.cp }}, {{ advert.country }}";
    let title = "{{ advert.title }}";
    let price = "{{ advert.price }}";

    geocoder.geocode({ 'address': address }, async function (results, status) {
      if (status === 'OK') {
        let location = results[0].geometry.location;
        let position = { lat: location.lat(), lng: location.lng() };

        // Chargement des bibliothèques
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerView } = await google.maps.importLibrary("marker");

        // Initialisation de la fenêtre d'information et de la carte
        const infoWindow = new google.maps.InfoWindow();
        map = new Map(document.getElementById("map"), {
          zoom: 14,
          minZoom: 6,
          center: position,
          mapId: "DEMO_MAP_ID",
          gestureHandling: "greedy",
        });

        // Création du marqueur pour l'annonce en cours
        let marker = new google.maps.Marker({
          position: position,
          map: map,
          title: title,
          label: {
            text: "C'est ici !",
            className: "custom-price-label"
          },
          cursor: "pointer"
        });

      } else {
        console.error(`Erreur de géocodage pour l'annonce "${title}": ${status}`);
      }
    });
  }

  // initMap();
</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKMfraFkzITgdFU4n3x1xu451mtxmGI8E&callback=initMap"></script>
{% endblock %}

{% block body %}
<div class="wrapper">
  <nav class="breadcrumb-nav">
    <ul class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ path('app_home') }}">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
            class="bi bi-house-door-fill" viewBox="0 0 16 16">
            <path
              d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.5v3.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5Z" />
          </svg>
        </a>
      </li>
      <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
          class="bi bi-caret-right-fill" viewBox="0 0 16 16">
          <path
            d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z" />
        </svg>
      </span>
      <li class="breadcrumb-item active" aria-current="page">Détail</li>
    </ul>
  </nav>
  <div class="wrapper-detail">
    <div class="wrapper-detail-title">
      <div class="detail-title-left">
        <h1>{{ advert.title }}</h1>
        <div class="address-wrap">
          <svg width="18" height="24" viewBox="0 0 18 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
            <rect width="18" height="24" fill="url(#pattern0)" />
            <defs>
              <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
                <use xlink:href="#image0_57_25" transform="matrix(0.01 0 0 0.0075 0 0.125)" />
              </pattern>
              <image id="image0_57_25" width="100" height="100"
                xlink:href="data:image/png;base64,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" />
            </defs>
          </svg>
          <p class="location">{{advert.city}}, {{advert.country}}</p>
        </div>
      </div>
      <div class="detail-title-right">
        <p class="location">{{advert.createdAtString}}</p>
      </div>
    </div>
    <div class="grid-wrap">
      {% if advert.images | length > 1 %}
      <div class="wrapper-detail-grid-img">
        <div class="l-img">
          {% if advert.images | length > 0 %} {% if app.user is same as
          advert.owner %}
          {% endif %}
          <img src="{{ asset('uploads/' ~ advert.images[0].url) }}" alt="{{ advert.title }}" />
          {% endif %}
        </div>
        <div class="sm-img">
          {% if advert.images | length > 1 %}
          <div class="ltl-img">
            <img src="{{ asset('uploads/' ~ advert.images[1].url) }}" alt="{{ advert.title }}" />
          </div>
          <div class="ltl-img">
            <img src="{{ asset('uploads/' ~ advert.images[2].url) }}" alt="{{ advert.title }}" />
            {% if advert.images | length > 3 %}
            <button id="showMoreBtn">Afficher plus</button>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% else %}
        <div class="single-img">
          {% if advert.images | length > 0 %}
          <img src="{{ asset('uploads/' ~ advert.images[0].url) }}" alt="{{ advert.title }}" />
          {% endif %}
        </div>
        {% endif %}
      </div>
      <div class="show-more-img" id="showMoreImg">
        <span class="close-btn" id="closeBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x"
            viewBox="0 0 16 16">
            <path
              d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
          </svg>
        </span>
        <div class="imgs-container">
          {% for image in advert.images %}
          <div class="img">
            <img src="{{ asset('uploads/' ~ image.url) }}" alt="{{ advert.title }}" />
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="wrapper-detail-main">
        <div class="wrapper-detail-left">
          <div class="wrapper-detail-left-category">
            <h2>Type</h2>
            <div id="checkbox-wrapper-type" class="checkbox-wrapper-16">
              {% if advert.lodge %}
              <div class="checkbox-wrapper">
                <span class="checkbox-tile">
                  <span class="checkbox-icon">
                    <img src="{{ asset('img/icons/types/' ~ advert.lodge.icon) }}" alt="{{ advert.lodge.type }}" />
                  </span>
                  <span class="checkbox-label">{{ advert.lodge.type }}</span>
                </span>
              </div>
              {% endif %}
            </div>
            <h2>Catégories</h2>
            <div id="checkbox-wrapper-categories" class="checkbox-wrapper-16">
              {% for category in advert.categories %}
              <div class="checkbox-wrapper">
                <span class="checkbox-tile">
                  <span class="checkbox-icon">
                    <img src="{{ asset('img/icons/categories/' ~ category.icon)}}" alt="{{ category.name }}" />
                  </span>
                  <span class="checkbox-label">{{ category.name }}</span>
                </span>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="wrapper-detail-left-owner">
            <div class="wrapper-detail-left-owner-info">
              {% if advert.owner.avatar is not null %}
              <p>Propriétaire - </p><span><img class="profil-picture"
                  src="{{ asset('uploads/avatars/' ~ advert.owner.avatar)}}" alt="">{{advert.owner.username}}</span>
              {% else %}
              <p>Propriétaire - <span>{{advert.owner.username}}</span></p>
              {% endif %}
            </div>
            <a href="#" class="wrapper-detail-left-owner-contact">
              Contacter
            </a>
          </div>
          <div class="wrapper-detail-left-description">
            <p>
              {{ advert.description|nl2br|raw }}
            </p>
          </div>
          <div class="wrapper-detail-left-commodite">
            <h2>Commodités</h2>
            <div class="checkbox-wrapper-17">
              {% for accessory in advert.accessories %}
              <div class="checkbox-wrapper">
                <span class="checkbox-tile-fit">
                  <span class="checkbox-icon">
                    <img src="{{ asset('img/icons/accessories/' ~ accessory.icon)}}" alt="{{ accessory.name }}" />
                  </span>
                  <span class="checkbox-label">{{ accessory.name }}</span>
                </span>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="wrapper-detail-left-map">
            <div id="map"></div>
          </div>
        </div>
        <div class="wrapper-detail-right">
          <span class="close-reservation-btn" id="closeReservationBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x"
              viewBox="0 0 16 16">
              <path
                d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
            </svg>
          </span>
          <div id="calendar-and-detail">
            {% if isLoggedIn %}
            {# Prix de la nuit #}
            <p class="night-price">
              <b>{{ advert.price }}€</b>/Nuits
            </p>

            {# Aperçu des dates choisies #}
            <div class="dates">
              <div class="date">
                <p>Arrivée :</p>
                <input class="date-span" type="date" id="arrivalDate" name="reservation[arrivalDate]" disabled />
              </div>
              <div class="date">
                <p>Départ :</p>
                <input class="date-span" type="date" id="departureDate" name="reservation[departureDate]" disabled />
              </div>
            </div>

            {# Calendrier #}
            <div id="calendar" data-advert-id="{{ advert.id }}" data-advert-id="{{ advert.id }}"
              data-reserved-dates="{{ reservedDates|json_encode|e('html_attr') }}"></div>
            <div id="alert-dates" style="display: none;">
              <div class="popup-container">
                <div class="popup-card">
                  <h2>Alerte</h2>
                  <p>Vous ne pouvez pas mettre de date antiérieur ou égale à la date d'arrivée</p>
                  <button id="close-popup">Close</button>
                </div>
              </div>
            </div>

            {# Détail des prix #}
            <div class="price-details">
              <div class="price">
                <p><span id="pricePerNight">{{advert.price}}</span> x <span id="numNights">0</span> nuits = </p><span
                  class="total-span" id="totalNightPrice">0€</span>
              </div>
              <div class="price">
                <p>Frais Stellar 5%:</p><span class="total-span" id="stellarFees">0€</span>
              </div>
              <div class="price">
                <p>Total:</p><span class="total-span" id="totalPrice">0€</span>
              </div>
            </div>
            <div class="log">
              <button class="l-btn" id="start-button" disabled>Réservation</button>
            </div>
            {% else %}
            <div class="connect">
              <img src="{{asset('img/illustrations/Sign up-pana.svg')}}" alt="login illustration">
              <p>
                Vous devez être connecté pour effectuer une réservation.
                <a href="{{ path('app_login') }}">
                  Se connecter
                </a>
                <a href="{{ path('app_register') }}">
                  S'inscrire
                </a>
              </p>
            </div>
            {% endif %}
          </div>
        </div>
        <div id="reservationFormContainer" class="reservation-form-container">
          <span id="close-reservation" class="close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x"
              viewBox="0 0 16 16">
              <path
                d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
            </svg>
          </span>
          <div class="reservation">
            {{ form_start(formAddReservation) }}
            <div id="step-2" style="display: none;">
              <div class="res-infos">
                <div class="title">
                  <h2>
                    Avant ça ... !
                  </h2>
                  <p>Remplissons quelques informations à votre propos !</p>
                </div>
                <div class="res-info">
                  <label for="firstname">Ajoutez votre nom</label>
                  {{ form_widget(formAddReservation.firstname) }}
                </div>
                <div class="res-info">
                  <label for="surname">Ajoutez votre prénom</label>
                  {{ form_widget(formAddReservation.surname) }}
                </div>
              </div>
              <div class="direction-btn">
                <span id="next-button-step-2" class="next-btn">
                  Next step
                </span>
              </div>
            </div>
            <div id="step-3" style="display: none;">
              <div class="res-infos">
                <div class="title">
                  <h2>
                    On y est presque !
                  </h2>
                  <p>Plus que ça et nous en auront fini !</p>
                </div>
                <div class="res-info">
                  <label for="address">Ajoutez votre n° et nom d'adresse</label>
                  {{ form_widget(formAddReservation.address) }}
                </div>
                <div class="res-info">
                  <label for="cp">Ajoutez votre code postal</label>
                  {{ form_widget(formAddReservation.cp) }}
                </div>
                <div class="res-info">
                  <label for="city">Ajoutez votre ville</label>
                  {{ form_widget(formAddReservation.city) }}
                </div>
                <div class="res-info">
                  <label for="country">Ajoutez votre pays</label>
                  {{ form_widget(formAddReservation.country) }}
                </div>
              </div>
              <div class="direction-btn">
                <span id="prev-button-step-3" class="prev-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-arrow-left-short" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                      d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z" />
                  </svg>
                  Back
                </span>
                {{ form_widget(formAddReservation.Reserver) }}
              </div>
              {{ form_end(formAddReservation) }}
            </div>
          </div>
        </div>
      </div>
      <div class="adverts-container">
        <h2>Du même propriétaire</h2>
        <div id="grid" class="advert-card-list">
          {% for advert in ownerAdverts|slice(0, 4) %}
          <div class="advert-card slide-in">
            <a href="{{ path('detail_advert', {'id': advert.id, 'slug': advert.slug})}}" class="clickable-card">
              <figure>
                {% if advert.images is not empty %}
                <img src="{{ asset('uploads/' ~ advert.images[0].url) }}" alt="{{ advert.title }} image">
                {% endif %}
              </figure>
              <div class="card-content">
                <h3 class="card-title">{{ advert.title}}</h3>
                <p class="card-text">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-geo-alt-fill" viewBox="0 0 16 16">
                    <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z" />
                  </svg>
                  {{ advert.city }},
                  {{ advert.country }}
                </p>
                <p class="card-text">
                  <span class="price-card">{{ advert.price }}€</span>/nuit
                </p>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="reservation-btn">
      <button class="l-btn fullsize-btn" id="reservation-btn">Réservation</button>
    </div>
    {% endblock %}
    {% block javascripts %}
    <script src="{{ asset('js/app.js') }}"></script>
    <script src="{{ asset('js/animations.js') }}"></script>
    <script src="{{ asset('js/reservation.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js">
    </script>
    <script>
      /****Show More Images****/

      // Cacher initialement la div showMoreImg
      $("#showMoreImg").hide();

      // Gérer l'affichage des images supplémentaires lorsque le bouton showMoreBtn est cliqué
      $("#showMoreBtn").click(function () {
        // Ajouter la classe popup-open pour désactiver le défilement
        $("body").addClass("popup-open");

        // Afficher la div showMoreImg
        $("#showMoreImg").fadeIn(300);
        $("#showMoreImg").show();
      });

      // Cacher la div showMoreImg lorsque le bouton closeBtn (croix) est cliqué
      $("#closeBtn").click(function () {
        // Enlever la classe popup-open pour réactiver le défilement
        $("body").removeClass("popup-open");

        $("#showMoreImg").fadeOut(300);
      });


      if (window.innerWidth < 450) {
        const reservationBtn = document.getElementById("reservation-btn");
        const closeReservationBtn = document.getElementById("closeReservationBtn");
        const wrapperDetail = document.querySelector(".wrapper-detail-right");

        reservationBtn.addEventListener("click", function () {
          wrapperDetail.style.display = "block";
        });

        closeReservationBtn.addEventListener("click", function () {
          wrapperDetail.style.display = "none";
        });
      }
    </script>
    {% endblock javascripts %}