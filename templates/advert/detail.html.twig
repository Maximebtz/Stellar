{% extends 'base.html.twig' %}
{% block title %}{{ advert.title }}{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('build/style.css') }}" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
  rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
{% endblock %}

{% block body %}
<div class="wrapper">
  <a href="{{ path("app_home") }}" class="return-home">
    <img src="{{ asset('img/icons/Left Arrow.svg') }}" alt="Icon return home">
  </a>
  <div class="wrapper-detail">
    <div class="wrapper-detail-title">
      <div class="detail-title-left">
        <h1>{{ advert.title }}</h1>
        <div class="address-wrap">
          <svg width="18" height="24" viewBox="0 0 18 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
            <rect width="18" height="24" fill="url(#pattern0)" />
            <defs>
              <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
                <use xlink:href="#image0_57_25" transform="matrix(0.01 0 0 0.0075 0 0.125)" />
              </pattern>
              <image id="image0_57_25" width="100" height="100"
                xlink:href="data:image/png;base64,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" />
            </defs>
          </svg>
          <p class="location">{{advert.city}}, {{advert.country}}</p>
        </div>
      </div>
      <div class="detail-title-right">
        <p class="location">{{advert.createdAtString}}</p>
      </div>
    </div>
    <div class="grid-wrap">
      {% if advert.images | length > 1 %}
      <div class="wrapper-detail-grid-img">
        <div class="l-img">
          {% if advert.images | length > 0 %} {% if app.user is same as
          advert.owner %}
          {% endif %}
          <img src="{{ asset('uploads/' ~ advert.images[0].url) }}" alt="{{ advert.title }}" />
          {% endif %}
        </div>
        <div class="sm-img">
          {% if advert.images | length > 1 %} {% for i in 1..(advert.images |
          length - 1) %}
          <div class="ltl-img">
            <img src="{{ asset('uploads/' ~ advert.images[i].url) }}" alt="{{ advert.title }}" />
          </div>
          {% endfor %} {% if advert.images | length > 3 %}
          <button id="showMoreBtn">Afficher plus</button>
          {% endif %} {% endif %}
        </div>
      </div>
      {% else %}
      <div class="single-img">
        {% if advert.images | length > 0 %}
        <img src="{{ asset('uploads/' ~ advert.images[0].url) }}" alt="{{ advert.title }}" />
        {% endif %}
      </div>
      {% endif %}
    </div>
    <div class="wrapper-detail-main">
      <div class="wrapper-detail-left">
        <div class="wrapper-detail-left-category">
          <div class="checkbox-wrapper-16">
            {% if advert.lodge %}
            <div class="checkbox-wrapper">
              <span class="checkbox-tile">
                <span class="checkbox-icon">
                  <img src="{{ asset('img/icons/types/' ~ advert.lodge.icon) }}" alt="{{ advert.lodge.type }}" />
                </span>
                <span class="checkbox-label">{{ advert.lodge.type }}</span>
              </span>
            </div>
            {% endif %}
          </div>
          <div class="checkbox-wrapper-16">
            {% for category in advert.categories %}
            <div class="checkbox-wrapper">
              <span class="checkbox-tile">
                <span class="checkbox-icon">
                  <img src="{{ asset('img/icons/categories/' ~ category.icon)}}" alt="{{ category.name }}" />
                </span>
                <span class="checkbox-label">{{ category.name }}</span>
              </span>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="wrapper-detail-left-owner">
          <div class="wrapper-detail-left-owner-info">
            {% if advert.owner.avatar is not null %}
            <p>Propriétaire - </p><img class="profil-picture" src="{{ asset('uploads/avatars/' ~ advert.owner.avatar)}}"
              alt=""><span>{{advert.owner.username}}</span>
            {% else %}
            <p>Propriétaire - <span class="profil-picture"></span><span>{{advert.owner.username}}</span></p>
            {% endif %}
          </div>
          <a href="#" class="wrapper-detail-left-owner-contact">
            Contacter
          </a>
        </div>
        <div class="wrapper-detail-left-description">
          <p>
            {{ advert.description|nl2br|raw }}
          </p>
        </div>
        <div class="wrapper-detail-left-commodite">
          <h2>Commodités</h2>
          <div class="checkbox-wrapper-17">
            {% for accessory in advert.accessories %}
            <div class="checkbox-wrapper">
              <span class="checkbox-tile-fit">
                <span class="checkbox-icon">
                  <img src="{{ asset('img/icons/accessories/' ~ accessory.icon)}}" alt="{{ accessory.name }}" />
                </span>
                <span class="checkbox-label">{{ accessory.name }}</span>
              </span>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="wrapper-detail-right">
        <div id="calendar-and-detail">
          <p class="night-price">
            <b>{{ advert.price }}€</b>/Nuits
          </p>
          <div class="dates">
            <div class="date">
              <p>Arrivée :</p>
              <input class="date-span" type="date" id="arrivalDate" name="reservation[arrivalDate]" disabled />
            </div>
            <div class="date">
              <p>Départ :</p>
              <input class="date-span" type="date" id="departureDate" name="reservation[departureDate]" disabled />
            </div>
          </div>

          <div id="calendar" data-advert-id="{{ advert.id }}" data-advert-id="{{ advert.id }}"
            data-reserved-dates="{{ reservedDates|json_encode|e('html_attr') }}"></div>

          <div class="price-details">
            <div class="price">
              <p><span id="pricePerNight">{{advert.price}}</span> x <span id="numNights">0</span> nuits = </p><span
                class="total-span" id="totalNightPrice">0€</span>
            </div>
            <div class="price">
              <p>Frais Stellar 5%:</p><span class="total-span" id="stellarFees">0€</span>
            </div>
            <div class="price">
              <p>Total:</p><span class="total-span" id="totalPrice">0€</span>
            </div>
          </div>
          <div class="log">
            <a href="#" class="l-btn">Réservation</a>
          </div>
        </div>
        <div id="reservation-form-container">
          {{ form_start(formAddReservation) }}

          {{ form_widget(formAddReservation.arrivalDate) }}
          {{ form_widget(formAddReservation.departureDate) }}

          {{ form_row(formAddReservation.firstname) }}
          {{ form_row(formAddReservation.surname) }}
          {{ form_row(formAddReservation.dateOfBirth) }}
          {{ form_row(formAddReservation.address) }}
          {{ form_row(formAddReservation.cp) }}
          {{ form_row(formAddReservation.city) }}
          {{ form_row(formAddReservation.country) }}

          <button type="submit" class="btn btn-primary">Réserver</button>
          {{ form_end(formAddReservation) }}
        </div>
      </div>

      {# Faire le formulaire sur la meme page avec un changement #}

    </div>
  </div>
</div>
{% endblock %}
{% block javascripts %}
<script src="{{ asset('js/app.js') }}"></script>
<script src="{{ asset('js/upload.js') }}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function () {
    
    var arrivalDateInput = $('[name="reservation[arrivalDate]"]');
    var departureDateInput = $('[name="reservation[departureDate]"]');
    var advertId = $('#calendar').data('advert-id');
    var reservedDates = $('#calendar').data('reserved-dates');

    $('#calendar').datepicker({
      maxViewMode: 0,
      language: "fr",
      multidate: 2,
      daysOfWeekHighlighted: "0,6",
      startDate: 'today',
      todayHighlight: true,
      beforeShowDay: function (date) {
        var formattedDate = $.datepicker.formatDate('yy-mm-dd', date);

        // Parcourir les dates réservées pour l'annonce
        for (var i = 0; i < reservedDates.length; i++) {
          var reservedStartDate = reservedDates[i][0];
          var reservedEndDate = reservedDates[i][1];

          // Comparer la date actuelle avec les dates réservées
          if (formattedDate >= reservedStartDate && formattedDate <= reservedEndDate) {
            // Render la date non cliquable (désactivée) la griser
            return {
              enabled: false,
              classes: 'disabled-date'
            };
          }
        }

        // Les dates non réservées resteront activées et ne seront pas grises
        return {
          enabled: true,
          classes: ''
        };
      }
    });


    $('#calendar').on('changeDate', function (e) {
      let selectedDates = e.dates;

      if (selectedDates.length === 2) {
        arrivalDateInput = selectedDates[0];
        departureDateInput = selectedDates[1];

        // Vérifier si arrivalDate est définie avant de l'utiliser
        if (arrivalDateInput) {
          // Formatage de la date au format "yyyy-MM-dd"
          let formattedDate = arrivalDateInput.getFullYear() + '-' + (arrivalDateInput.getMonth() + 1).toString().padStart(2, '0') + '-' + arrivalDateInput.getDate().toString().padStart(2, '0');
          $('[name="reservation[arrivalDate]"]').val(formattedDate); // Mettez à jour la valeur du champ d'arrivée
        }
        // Vérifier si departureDate est définie avant de l'utiliser
        if (departureDateInput) {
          // Formatage de la date au format "yyyy-MM-dd"
          let formattedDate = departureDateInput.getFullYear() + '-' + (departureDateInput.getMonth() + 1).toString().padStart(2, '0') + '-' + departureDateInput.getDate().toString().padStart(2, '0');
          $('[name="reservation[departureDate]"]').val(formattedDate); // Mettez à jour la valeur du champ de départ
        }

        $('#calendar').find('.day').each(function () {
          let currentDate = new Date($(this).data('date'));
          if (currentDate > arrivalDateInput && currentDate < departureDateInput) {
            $(this).addClass('range');
          } else {
            $(this).removeClass('range');
          }
        });

        // Calcul du nombre de nuits
        let numNights = Math.floor((departureDateInput - arrivalDateInput) / (1000 * 60 * 60 * 24));
        $('#numNights').text(numNights);

        // Calcul du montant total des nuits
        let pricePerNight = parseFloat($('#pricePerNight').text());
        let totalNightPrice = (pricePerNight * numNights).toFixed(2);
        $('#totalNightPrice').text(totalNightPrice + '€');

        // Calcul du montant des frais Stellar (5%)
        let stellarFees = (totalNightPrice * 0.05).toFixed(2);
        $('#stellarFees').text(stellarFees + '€');

        // Calcul du total (nuits + frais)
        let totalPrice = (parseFloat(totalNightPrice) + parseFloat(stellarFees)).toFixed(2);
        $('#totalPrice').text(totalPrice + '€');
      } else {
        arrivalDateInput = null;
        departureDateInput = null;
        $('#calendar').find('.day').removeClass('range');
        $('[name="reservation[arrivalDate]"]').val('');
        $('[name="reservation[departureDate]"]').val('');
        $('#numNights').text('0');
        $('#totalNightPrice').text('0€');
        $('#stellarFees').text('0€');
        $('#totalPrice').text('0€');
      }
    });

    function formatDate(date) {
      let day = date.getDate();
      let month = date.getMonth() + 1;
      let year = date.getFullYear();

      if (day < 10) {
        day = '0' + day;
      }
      if (month < 10) {
        month = '0' + month;
      }

      return day + '/' + month + '/' + year;
    }
  });
</script>
{% endblock javascripts %}