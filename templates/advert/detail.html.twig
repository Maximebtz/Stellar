{% extends 'base.html.twig' %}
{% block title %}{{ advert.title }}{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('build/style.css') }}" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
  rel="stylesheet">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.js"></script>
<script src="https://cdn.maptiler.com/leaflet-maptilersdk/v1.0.0/leaflet-maptilersdk.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
{% endblock %}

{% block body %}
<div class="wrapper">
  <a href="{{ path("app_home") }}" class="return-home">
    <img src="{{ asset('img/icons/Left Arrow.svg') }}" alt="Icon return home">
  </a>
  <div class="wrapper-detail">
    <div class="wrapper-detail-title">
      <div class="detail-title-left">
        <h1>{{ advert.title }}</h1>
        <div class="address-wrap">
          <svg width="18" height="24" viewBox="0 0 18 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink">
            <rect width="18" height="24" fill="url(#pattern0)" />
            <defs>
              <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
                <use xlink:href="#image0_57_25" transform="matrix(0.01 0 0 0.0075 0 0.125)" />
              </pattern>
              <image id="image0_57_25" width="100" height="100"
                xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGEklEQVR4nO2dWYhcRRSGj7u4iwtRwT06D4JiFMVHQUwUI6IiqLigcXlxfVDc2ifFncm0t/6/uicDY9wGBKPog7ghiHGZPMSITwlmNTGLGA2aMcmVIhcJWbt7qm6durc/ODAMdHOWvrWdU+eK9OnTpwJkWXYiyesBNAC8TXIcwBKSG0hOFLKh+N84ybdIPuM+Mzw8fEJs/StBq9WaRvIVkj8C2EYy70WKzy4svuvC2HYlRbvdPhLAIwAW9RqADgLkvvvhZrN5RGx71ZJl2bHFcLQ+VCB2I+vcsDYyMnJMbPvVkOf5fsaY20iuKTEQOz8x6wHc43SROmOtPQPAV7ECwV0D86Ux5nSpI8aYa4sVUq5M/iB5o9QFNywAeEGB4/O9PCnbADxX+SFsbGzsAJLt2A5n54EZJXmQVBFnGIB5sZ3M7uX9RqNxoFQJ9+iTnKPAuXmPT8rcSg1f2ucMdibPSxUAcM1kjj2oRJwN1trrJGVInlryzjsPHJTf3d5JEl7eqtn00Z98keR8Yq29Q4Hz8hBirb1FEjwo/C224xhOfh0cHDxKUoHkswqclgeWJyUFRkdHDye5VoHD8sCyLol8iksuKXBWXoYAeEi0U6RK6xKQRaIZABfFdhJLFmPM+aIVAK+W5IhlAIYATCc54OatYu4aKP7XBLC8JF1eFK246pDAxq9wqdZOTl8bjcb+LtEE4JfAOi0QrXVTIc+sAMxzFSnd6uU+Q/KDgAHZSvJ40YYrSAto9Gz3i+9Vt+JpmR1KP5WHjq6EJ9CT8bHLNE5WPxeUUAkyAE+JNorSTd/GruhlmNpHEd7KAAGZK9oA8INvQ40xd/nW01o7K0BAvhNtBFjNLPMxVO2MW6H5XhK7Am/RRoBE1OxQurp9imdd14o2AGz2bOSMULoaY67yrOs/og0AW3waaYyZGkrXLMvO9RyQf0UbAP7yaWQz4NG2+26fugLYKNrwnSFse1zu7mH37jMgq0UbJH/2aaS19pyAug54HrIWijZcKX+NJ/VPRRtut+rZyGZAXV/3rOsc0QaAJ3waCWB5KhtDko+KNkjO9GxkTvLuAHre61tPY8wVoo0sy870bSiAlT5XW66WiuSqAD+ck0Rp6ehGzcfvDJCockdGohWS8wP8+nLNCSoAn4lWALwUKCC5+3X3Mny5YQrAhwH1elq0UlR8hDI8L04DHuy0yKG4/x5izthRLhGtkDzMnXwGdkBeLFvdEfoMt+t2Z1PF+dSA2/S5fUYZZUDuvkiIpblX3P2J0I6gHnlPtOMS/goclZchAO4T7VhrL4jtKJYjW40xp0gKkPxJgcPywPK5pELRyS2vslhrZ0kqkDyrClehuWeZGBoaOk5SwtUqKXBcHkJcBaSkhrtdFNtxDCfptW9ybfN8Fz5QgRSlqGl2CEqpFROrcHZVtz0JgM3NZnOKpAyAr2M7kv7kDUkdkjcrcGRe+ZPdLjvJLVHgzLyyiahuIXl/bIdykmKtvVyqwuDg4CHuNlRsp7J3mS9Vw/VaV+DYvEe5WqpGkU2M1k6cvcuCJBuWVfgpmSFVZWxs7GCSixU4Oe9EXAG5VB0AtybUhfRSqTpF0dp4AgF5V+qCtfbK2A7n3mUi5B1HlZD8SIHj8z3Iy1I3Wq3W2WUU1bH7oWo1yaOljrh+6rEDwF3ldqkrbrNYQoOxvAv5fjJV9pUAwE1KhqotrmdkbH+oIHDHt7xDeS22H1S9RYHknxGDsTSJpsg1KhuaGdt+rS8M+zZCMN6Jbbtasiw7r+S9yZr+m6T3AYDHygqIMeaGcn5qCdPY3j20jDfzvBnb1mQwxkwluSlgMFYlV70eGwZogbHDa1Wnx7YvSRimF3D9TnI9V9Av8RiMcZdGjm1X0pC82EfHU3c1wjW/jG1PJSD5+GQD4l7jF9uOquXhP5lEQMZi21A5ms3mlCKb120wFtc2Axgakpd1M58A+LvVak2LrXelIflAFwG5M7a+tQDAcAfBGIqtZ20YGRk5dG/34AF8099vlEy73T5td5N80Tjz5LL16SP/v8hy046TeCXuAaaM2d42fKkrJ3J/x9anT58+EpD/AOYFyBjym5/GAAAAAElFTkSuQmCC" />
            </defs>
          </svg>
          <p>{{advert.city}}, {{advert.country}}</p>
        </div>
      </div>
      <div class="detail-title-right">
        <p>{{advert.createdAtString}}</p>
      </div>
    </div>
    <div class="grid-wrap">
      {% if advert.images | length > 1 %}
      <div class="wrapper-detail-grid-img">
        <div class="l-img">
          {% if advert.images | length > 0 %} {% if app.user is same as
          advert.owner %}
          <div class="modif-icons">
            {#
            <a class="modif" href="{{ path('remove_advert_image', { id: advert.images }) }}">
              #}
              <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" fill="currentColor" class="bi bi-x"
                viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 
                   8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
              </svg>
              {#
            </a>
            #}
          </div>
          {% endif %}
          <img src="{{ asset('uploads/' ~ advert.images[0].url) }}" alt="{{ advert.title }}" />
          {% endif %}
        </div>
        <div class="sm-img">
          {% if advert.images | length > 1 %} {% for i in 1..(advert.images |
          length - 1) %}
          <div class="ltl-img">
            {% if app.user is same as advert.owner %}
            <div class="modif-icons">
              <a class="modif" href="{{
                  path('remove_advert_image', {
                    advertId: advert.id,
                    imageId: advert.images[i].id
                  })
                }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="19" height="19" fill="currentColor" class="bi bi-x"
                  viewBox="0 0 16 16">
                  <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 
                    8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                </svg>
              </a>
            </div>
            {% endif %}
            <img src="{{ asset('uploads/' ~ advert.images[i].url) }}" alt="{{ advert.title }}" />
          </div>
          {% endfor %} {% if advert.images | length > 3 %}
          <button id="showMoreBtn">Afficher plus</button>
          {% endif %} {% endif %}
        </div>
      </div>
      {% else %}
      <div class="single-img">
        {% if advert.images | length > 0 %}
        <img src="{{ asset('uploads/' ~ advert.images[0].url) }}" alt="{{ advert.title }}" />
        {% endif %}
      </div>
      {% endif %}
    </div>
    <div class="wrapper-detail-main">
      <div class="wrapper-detail-left">
        <div class="wrapper-detail-left-category">
          <div class="checkbox-wrapper-16">
            {% if advert.lodge %}
            <div class="checkbox-wrapper">
              <span class="checkbox-tile">
                <span class="checkbox-icon">
                  <img src="{{ asset('img/icons/types/' ~ advert.lodge.icon) }}" alt="{{ advert.lodge.type }}" />
                </span>
                <span class="checkbox-label">{{ advert.lodge.type }}</span>
              </span>
            </div>
            {% endif %}
          </div>
          <div class="checkbox-wrapper-16">
            {% for category in advert.categories %}
            <div class="checkbox-wrapper">
              <span class="checkbox-tile">
                <span class="checkbox-icon">
                  <img src="{{ asset('img/icons/categories/' ~ category.icon)}}" alt="{{ category.name }}" />
                </span>
                <span class="checkbox-label">{{ category.name }}</span>
              </span>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="wrapper-detail-left-owner">
          <div class="wrapper-detail-left-owner-info">
            {% if advert.owner.avatar is not null %}
            <p>Propriétaire - </p><img class="profil-picture" src="{{ asset('uploads/avatars/' ~ advert.owner.avatar)}}"
              alt=""><span>{{advert.owner.username}}</span>
            {% else %}
            <p>Propriétaire - <span class="profil-picture"></span><span>{{advert.owner.username}}</span></p>
            {% endif %}
          </div>
          <a href="#" class="wrapper-detail-left-owner-contact">
            Contacter
          </a>
        </div>
        <div class="wrapper-detail-left-description">
          <p>
            {{ advert.description|nl2br|raw }}
          </p>
        </div>
        <div class="wrapper-detail-left-commodite">
          <h2>Commodités</h2>
          <div class="checkbox-wrapper-16">
            {% for accessory in advert.accessories %}
            <div class="checkbox-wrapper">
              <span class="checkbox-tile-fit">
                <span class="checkbox-icon">
                  <img src="{{ asset('img/icons/accessories/' ~ accessory.icon)}}" alt="{{ accessory.name }}" />
                </span>
                <span class="checkbox-label">{{ accessory.name }}</span>
              </span>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="wrapper-detail-right">
        <p class="night-price">
          <b>{{ advert.price }}€</b>/Nuits
        </p>

        <div class="dates">
          <div class="date">
            <p>Arrivée :</p>
            <div class="date-span"><span id="arrivalDate"></span></div>
          </div>
          <div class="date">
            <p>Départ :</p>
            {# <div class="date-span"><span id="departureDate"></span></div> #}
            <div class="date-span"><input type="date"  id="departureDate"/></div>
          </div>
        </div>

        <div id="calendar"></div>

        <div class="price-details">
          <div class="price">
            <p><span id="pricePerNight">{{advert.price}}</span> x <span id="numNights">0</span> nuits = </p><span
              class="total-span" id="totalNightPrice">0€</span>
          </div>
          <div class="price">
            <p>Frais Stellar 5%:</p><span class="total-span" id="stellarFees">0€</span>
          </div>
          <div class="price">
            <p>Total:</p><span class="total-span" id="totalPrice">0€</span>
          </div>
        </div>
        <div class="log">
          <a href="{{ path('app_reservation', {'id': advert.id}) }}" class="l-btn">Réservation</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function () {
    let dateArrivee;
    let dateDepart;

    $('#calendar').datepicker({
      maxViewMode: 0,
      language: "fr",
      multidate: 2,
      daysOfWeekHighlighted: "0,6",
      startDate: 'today',
      todayHighlight: true
    });

    $('#calendar').on('changeDate', function (e) {
      let selectedDates = e.dates;

      if (selectedDates.length === 2) {
        dateArrivee = selectedDates[0];
        dateDepart = selectedDates[1];

        $('#arrivalDate').text(formatDate(dateArrivee));
        $('#departureDate').text(formatDate(dateDepart));

        // Chercher comment mettre une value dans un input*

        $('#calendar').find('.day').each(function () {
          let currentDate = new Date($(this).data('date'));
          if (currentDate > dateArrivee && currentDate < dateDepart) {
            $(this).addClass('range');
          } else {
            $(this).removeClass('range');
          }
        });

        // Calcul du nombre de nuits
        let numNights = Math.floor((dateDepart - dateArrivee) / (1000 * 60 * 60 * 24));
        $('#numNights').text(numNights);

        // Calcul du montant total des nuits
        let pricePerNight = parseFloat($('#pricePerNight').text());
        let totalNightPrice = (pricePerNight * numNights).toFixed(2);
        $('#totalNightPrice').text(totalNightPrice + '€');

        // Calcul du montant des frais Stellar (5%)
        let stellarFees = (totalNightPrice * 0.05).toFixed(2);
        $('#stellarFees').text(stellarFees + '€');

        // Calcul du total (nuits + frais)
        let totalPrice = (parseFloat(totalNightPrice) + parseFloat(stellarFees)).toFixed(2);
        $('#totalPrice').text(totalPrice + '€');
      } else {
        dateArrivee = null;
        dateDepart = null;
        $('#calendar').find('.day').removeClass('range');
        $('#arrivalDate').text('');
        $('#departureDate').text('');
        $('#numNights').text('0');
        $('#totalNightPrice').text('0€');
        $('#stellarFees').text('0€');
        $('#totalPrice').text('0€');
      }

      localStorage.setItem('arrivalDate', formatDate(dateArrivee));
      localStorage.setItem('departureDate', formatDate(dateDepart));
      localStorage.setItem('totalPrice', totalPrice.toString());
      localStorage.setItem('stellarFees', stellarFees.toString());
      localStorage.setItem('totalNightPrice', totalNightPrice.toString());
    });

    function formatDate(date) {
      let day = date.getDate();
      let month = date.getMonth() + 1;
      let year = date.getFullYear();

      if (day < 10) {
        day = '0' + day;
      }
      if (month < 10) {
        month = '0' + month;
      }

      return day + '/' + month + '/' + year;
    }
  });
</script>
{% endblock javascripts %}